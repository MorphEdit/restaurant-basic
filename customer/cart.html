<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="menu.html">Restaurant</a>
            <span class="navbar-text">
                Table: <span id="tableNumber" class="fw-bold">Loading...</span>
            </span>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row g-4">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Your Order</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="cartItems">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Special Instructions</h5>
                        <textarea class="form-control" id="specialInstructions" rows="3" 
                                  placeholder="Any special requests? (Optional)"></textarea>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span class="price">฿<span id="subtotal">0</span></span>
                        </div>
                        <div class="total-section">
                            <div class="d-flex justify-content-between">
                                <strong>Total Amount</strong>
                                <strong class="price">฿<span id="total">0</span></strong>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary w-100 mt-4" onclick="placeOrder()">
                            Place Order
                        </button>
                        <a href="menu.html" class="btn btn-outline-secondary w-100 mt-2">
                            Add More Items
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to place this order?</p>
                    <div class="total-section">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Total Amount:</strong>
                            <span class="price fs-4">฿<span id="confirmTotal">0</span></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmOrder()">Confirm Order</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let cart = [];
        let tableId = null;
        let confirmModal;

        document.addEventListener('DOMContentLoaded', function() {
            const savedCart = sessionStorage.getItem('cart');
            if (!savedCart) {
                window.location.href = 'menu.html';
                return;
            }
            cart = JSON.parse(savedCart);

            tableId = sessionStorage.getItem('tableId');
            if (!tableId) {
                window.location.href = 'menu.html';
                return;
            }

            confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

            loadTableInfo();
            displayCartItems();
            calculateTotals();
        });

        function loadTableInfo() {
            axios.get(`../api/tables/table.php?action=list`)
                .then(response => {
                    const table = response.data.data.find(t => t.id == tableId);
                    if (table) {
                        document.getElementById('tableNumber').textContent = table.table_number;
                    }
                });
        }

        function displayCartItems() {
            const cartDiv = document.getElementById('cartItems');
            cartDiv.innerHTML = '';

            cart.forEach((item, index) => {
                let addonHTML = '';
                if (item.addons && item.addons.length > 0) {
                    addonHTML = item.addons.map(addon => 
                        `<span class="addon-tag">+ ${addon.name} (฿${addon.price})</span>`
                    ).join(' ');
                }

                cartDiv.innerHTML += `
                    <div class="cart-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold mb-1">${item.name}</div>
                                <div class="d-flex flex-wrap gap-1">
                                    ${addonHTML}
                                </div>
                                <div class="text-muted small mt-1">฿${item.totalPrice.toFixed(2)} x ${item.quantity}</div>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <span class="price">฿${(item.totalPrice * item.quantity).toFixed(2)}</span>
                                <div class="quantity-control">
                                    <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">-</button>
                                    <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">+</button>
                                </div>
                                <button class="remove-btn" onclick="removeItem(${index})">×</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function updateQuantity(index, change) {
            const newQuantity = cart[index].quantity + change;
            if (newQuantity >= 1) {
                cart[index].quantity = newQuantity;
                displayCartItems();
                calculateTotals();
                sessionStorage.setItem('cart', JSON.stringify(cart));
            }
        }

        function removeItem(index) {
            cart.splice(index, 1);
            if (cart.length === 0) {
                window.location.href = 'menu.html';
                return;
            }
            displayCartItems();
            calculateTotals();
            sessionStorage.setItem('cart', JSON.stringify(cart));
        }

        function calculateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.totalPrice * item.quantity), 0);
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('total').textContent = subtotal.toFixed(2);
            document.getElementById('confirmTotal').textContent = subtotal.toFixed(2);
        }

        function placeOrder() {
            confirmModal.show();
        }

        function confirmOrder() {
            const orderData = {
                table_id: tableId,
                items: cart.map(item => ({
                    menu_item_id: item.id,
                    quantity: item.quantity,
                    price: item.price,
                    addons: item.addons.map(addon => ({
                        id: addon.id,
                        name: addon.name,
                        price: addon.price
                    }))
                })),
                total_amount: parseFloat(document.getElementById('total').textContent),
                special_instructions: document.getElementById('specialInstructions').value
            };

            axios.post('../api/orders/order.php?action=create', orderData)
                .then(response => {
                    console.log('Order created:', response.data);
                    if (response.data.status === 'success') {
                        const orderId = response.data.order_id;
                        sessionStorage.removeItem('cart');
                        window.location.href = `payment.html?order=${orderId}`;
                    } else {
                        throw new Error(response.data.message || 'Failed to create order');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error creating order: ' + (error.response?.data?.message || error.message));
                    confirmModal.hide();
                });
        }
    </script>
</body>
</html>